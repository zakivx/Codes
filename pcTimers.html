<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>4 Timers with Password, Auto Timer, Reset All & Event History + Persistent Running State</title>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #f5f5f5;
        margin: 0; padding: 20px;
    }
    .timer-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    .timer-box {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
        width: 200px;
    }
    .timer-name {
        font-weight: bold;
        font-size: 20px;
        margin-bottom: 10px;
    }
    .time {
        font-size: 22px;
        font-weight: bold;
    }
    .added-time {
        font-size: 16px;
        color: #777;
    }
    button {
        margin-top: 8px;
        margin-right: 5px;
        padding: 5px 10px;
        font-size: 14px;
        cursor: pointer;
    }
    #resetAllBtn {
        margin-top: 0;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
    #eventHistory {
        max-width: 650px;
        margin: 30px auto 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
        padding: 15px;
        height: 220px;
        overflow-y: auto;
        text-align: left;
        font-family: monospace;
        font-size: 14px;
        user-select: none;
        position: relative;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }
    thead tr {
        background: #ddd;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #clearHistoryBtn {
        margin-top: 10px;
        padding: 8px 20px;
        font-size: 14px;
        cursor: pointer;
        background-color: #d9534f;
        color: white;
        border: none;
        border-radius: 4px;
    }
    #clearHistoryBtn:hover {
        background-color: #c9302c;
    }
    #eventHeaderContainer {
        max-width: 650px;
        margin: 30px auto 0 auto;
        text-align: center;
    }
    #clearButtonContainer {
        max-width: 650px;
        margin: 10px auto 0 auto;
        text-align: center;
    }
</style>
</head>
<body>

<h2>Timers</h2>
<div class="timer-container">
    <div class="timer-box" id="tahaBox">
        <div class="timer-name">Taha</div>
        <div class="time" id="tahaTime">00:00:00</div>
        <div class="added-time" id="tahaAdded">+00:00:00</div>
        <button onclick="startTimer('taha')">Start</button>
        <button onclick="stopTimer('taha')">Stop</button>
    </div>

    <div class="timer-box" id="hamzaBox">
        <div class="timer-name">Hamza</div>
        <div class="time" id="hamzaTime">00:00:00</div>
        <div class="added-time" id="hamzaAdded">+00:00:00</div>
        <button onclick="startTimer('hamza')">Start</button>
        <button onclick="stopTimer('hamza')">Stop</button>
    </div>

    <div class="timer-box" id="tesnimBox">
        <div class="timer-name">Tesnim</div>
        <div class="time" id="tesnimTime">00:00:00</div>
        <div class="added-time" id="tesnimAdded">+00:00:00</div>
        <button onclick="startTimer('tesnim')">Start</button>
        <button onclick="stopTimer('tesnim')">Stop</button>
    </div>

    <div class="timer-box" id="autoBox">
        <div class="timer-name">Auto Timer</div>
        <div class="time" id="autoTime">00:00:00</div>
        <div class="added-time" id="autoAdded">+00:00:00</div>
    </div>
</div>

<button id="resetAllBtn" onclick="resetAllTimers()">Reset All Timers</button>

<!-- Event History Header -->
<div id="eventHeaderContainer">
    <h3>Event History</h3>
</div>

<!-- Event History Table -->
<div id="eventHistory">
    <table>
        <thead>
            <tr>
                <th>Event</th>
                <th>Timer</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="eventTableBody">
            <!-- Events go here -->
        </tbody>
    </table>
</div>

<!-- Clear Button BELOW the eventHistory div -->
<div id="clearButtonContainer">
    <button id="clearHistoryBtn" onclick="clearEventHistory()">Clear Event History</button>
</div>

<script>
let timers = {
    taha: {password: "111", ref: 0, start: null, running: false, added: 0},
    hamza: {password: "222", ref: 0, start: null, running: false, added: 0},
    tesnim: {password: "333", ref: 0, start: null, running: false, added: 0},
    auto: {ref: 0, start: null, running: false, added: 0}
};

// Load timers from cookies, restore running state and start timestamps
for (let key in timers) {
    let saved = getCookie(key);
    if (saved) {
        try {
            let obj = JSON.parse(saved);
            timers[key].ref = obj.ref || 0;
            timers[key].added = obj.added || 0;
            timers[key].start = obj.start || null;
            timers[key].running = !!obj.start;
        } catch {
            // ignore parse errors
        }
    }
}

// Load event history from cookie
function loadEventHistoryFromCookie() {
    const historyJSON = getCookie("eventHistory");
    if (!historyJSON) return;

    try {
        const events = JSON.parse(historyJSON);
        const tbody = document.getElementById("eventTableBody");
        tbody.innerHTML = "";
        // Add oldest first so newest events appear on top by insertBefore
        events.forEach(ev => {
            const tr = document.createElement("tr");
            ["event", "timer", "time"].forEach(key => {
                const td = document.createElement("td");
                td.textContent = ev[key];
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    } catch {
        // ignore parse errors
    }
}

// Save event history to cookie
function saveEventHistoryToCookie() {
    const tbody = document.getElementById("eventTableBody");
    const events = [];
    for (let row of tbody.rows) {
        events.push({
            event: row.cells[0].textContent,
            timer: row.cells[1].textContent,
            time: row.cells[2].textContent
        });
    }
    setCookie("eventHistory", JSON.stringify(events), 365);
}

// Helper: format time HH:MM:SS
function formatTime(sec) {
    let h = String(Math.floor(sec / 3600)).padStart(2, '0');
    let m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
    let s = String(sec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
}
// Helper: format time for event (12h AM/PM)
function formatEventTime(date = new Date()) {
    let h = date.getHours();
    let ampm = h >= 12 ? "PM" : "AM";
    h = h % 12 || 12;
    let m = String(date.getMinutes()).padStart(2,'0');
    return `${h}:${m}${ampm}`;
}

// Update the event history table UI and save to cookie
function addEvent(type, timerName) {
    const tbody = document.getElementById("eventTableBody");
    const timeStr = formatEventTime();
    const tr = document.createElement("tr");

    let tdType = document.createElement("td");
    tdType.textContent = type.charAt(0).toUpperCase() + type.slice(1);
    tr.appendChild(tdType);

    let tdName = document.createElement("td");
    tdName.textContent = timerName.charAt(0).toUpperCase() + timerName.slice(1);
    tr.appendChild(tdName);

    let tdTime = document.createElement("td");
    tdTime.textContent = timeStr;
    tr.appendChild(tdTime);

    // Insert new event at the top
    if(tbody.firstChild){
        tbody.insertBefore(tr, tbody.firstChild);
    } else {
        tbody.appendChild(tr);
    }

    saveEventHistoryToCookie();
}

function clearEventHistory() {
    let pass = prompt("Enter password to clear event history:");
    if (pass !== "999") {
        alert("Wrong password!");
        return;
    }
    const tbody = document.getElementById("eventTableBody");
    tbody.innerHTML = "";
    saveEventHistoryToCookie();
    addEvent("cleared", "system");
}

let autoStartTimeout = null;

// Timer controls
function startTimer(name) {
    let pass = prompt("Enter password for " + name);
    if (pass !== timers[name].password) return alert("Wrong password");

    // Stop the auto timer first if running and add its stop event
    if (timers.auto.running) {
        stopAutoTimer();
    }

    // Stop all manual timers first and add their stop events BEFORE start event
    stopAllTimers(true);

    // Now start the requested timer
    timers[name].running = true;
    timers[name].start = Date.now();
    saveToCookie(name);

    addEvent("start", name);
}

function stopTimer(name) {
    let pass = prompt("Enter password to stop " + name);
    if (pass !== timers[name].password) return alert("Wrong password");

    if (timers[name].running) {
        let elapsed = Math.floor((Date.now() - timers[name].start) / 1000);
        timers[name].ref += elapsed;
        timers[name].added = 0;
        timers[name].running = false;
        timers[name].start = null;
        saveToCookie(name);
        addEvent("stop", name);

        // Schedule auto timer start after a short delay
        scheduleAutoStart();
    }
}

// Modified stopAllTimers to accept param and add stops first
function stopAllTimers(suppressEvent = false) {
    let stoppedTimers = [];
    for (let t in timers) {
        if (t !== "auto" && timers[t].running) {
            let elapsed = Math.floor((Date.now() - timers[t].start) / 1000);
            timers[t].ref += elapsed;
            timers[t].added = 0;
            timers[t].running = false;
            timers[t].start = null;
            saveToCookie(t);
            stoppedTimers.push(t);
        }
    }
    if (!suppressEvent) {
        stoppedTimers.forEach(t => addEvent("stop", t));
    } else {
        stoppedTimers.forEach(t => addEvent("stop", t));
    }

    // Schedule auto timer start after manual timers stop
    scheduleAutoStart();
}

// Auto timer controls
function startAutoTimer() {
    if (!timers.auto.running) {
        timers.auto.running = true;
        timers.auto.start = Date.now();
        saveToCookie("auto");
        addEvent("start", "auto");
    }
}
function stopAutoTimer() {
    if (timers.auto.running) {
        let elapsed = Math.floor((Date.now() - timers.auto.start) / 1000);
        timers.auto.ref += elapsed;
        timers.auto.added = 0;
        timers.auto.running = false;
        timers.auto.start = null;
        saveToCookie("auto");
        addEvent("stop", "auto");
    }
}

// Schedule auto timer start with delay to keep event order correct
function scheduleAutoStart() {
    if (autoStartTimeout) clearTimeout(autoStartTimeout);
    autoStartTimeout = setTimeout(() => {
        if (!timers.taha.running && !timers.hamza.running && !timers.tesnim.running) {
            startAutoTimer();
        }
    }, 100);
}

function resetAllTimers() {
    let masterPass = prompt("Enter master password to reset all timers:");
    if(masterPass !== "999") {
        alert("Wrong password!");
        return;
    }
    ["taha", "hamza", "tesnim", "auto"].forEach(name => {
        timers[name].ref = 0;
        timers[name].added = 0;
        timers[name].running = false;
        timers[name].start = null;
        saveToCookie(name);
    });
    updateDisplay();

    const tbody = document.getElementById("eventTableBody");
    tbody.innerHTML = "";
    saveEventHistoryToCookie();
    addEvent("reset all timers", "system");
}

function saveToCookie(name) {
    const timer = timers[name];
    // Save start only if running, else null
    const obj = {
        ref: timer.ref,
        added: timer.added,
        start: timer.running && timer.start ? timer.start : null
    };
    setCookie(name, JSON.stringify(obj), 365);
}

function setCookie(cname, cvalue, exdays) {
    let d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    let expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + encodeURIComponent(cvalue) + ";" + expires + ";path=/";
}

function getCookie(cname) {
    let name = cname + "=";
    let ca = document.cookie.split(';');
    for(let i=0; i<ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(name) === 0) return decodeURIComponent(c.substring(name.length, c.length));
    }
    return "";
}

function updateDisplay() {
    for (let name of ["taha", "hamza", "tesnim", "auto"]) {
        let total = timers[name].ref;
        let added = timers[name].added;
        if (timers[name].running && timers[name].start) {
            added = Math.floor((Date.now() - timers[name].start) / 1000);
        }
        document.getElementById(name + "Time").innerText = formatTime(total);
        document.getElementById(name + "Added").innerText = "+" + formatTime(added);
    }
}

// Run updateDisplay every second for live display
setInterval(() => {
    updateDisplay();
}, 1000);

window.onload = () => {
    updateDisplay();

    // Load event history from cookie
    loadEventHistoryFromCookie();

    // If no manual timers running at load, start auto timer automatically
    if (!timers.taha.running && !timers.hamza.running && !timers.tesnim.running) {
        startAutoTimer();
    }
}
</script>

</body>
</html>
