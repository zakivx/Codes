<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fixed DOCX Viewer</title>
  <style>
    :root{--toolbar-bg:#111827;--toolbar-fg:#ffffff;--accent:#2563eb}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{background:#f3f4f6;display:flex;flex-direction:column}

    /* Toolbar */
    .toolbar{background:var(--toolbar-bg);color:var(--toolbar-fg);padding:10px 12px;display:flex;gap:8px;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .title{font-weight:600;margin-right:8px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--toolbar-fg);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn:focus{outline:2px solid rgba(255,255,255,.12)}
    .btn.primary{background:var(--accent);border-color:transparent}
    .spacer{flex:1}

    /* Viewer area */
    .viewer-wrap{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:18px;overflow:auto;background:white}
    .viewer{max-width:1000px;width:100%;background:white}

    /* Web layout: display content full width */
    .web .doc-content{padding:20px}

    /* Print layout: emulate A4 pages stacked */
    .print .doc-content{padding:24px;display:flex;flex-direction:column;gap:18px;align-items:center}
    .page{width:210mm;min-height:297mm;padding:24mm 18mm;border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(0,0,0,.08);background:white;page-break-after:always;margin-bottom:18px;overflow:visible}
    .page:last-child{page-break-after:auto}

    /* Loading */
    .loading{display:flex;gap:10px;align-items:center}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(0,0,0,.3);animation:blink 1s infinite}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes blink{0%,50%,100%{opacity:1}25%{opacity:.2}}

    /* Make content text readable */
    .doc-content p{line-height:1.55}
    .doc-content img{max-width:100%;height:auto}

    /* Print-friendly rules */
    @media print{
      body{background:white}
      .toolbar{display:none}
      .page{box-shadow:none;border:none;width:auto;min-height:auto;padding:0;page-break-after:always}
      .page:last-child{page-break-after:auto}
    }

    /* Small screens adjustments */
    @media (max-width:700px){
      .page{width:100%;min-height:unset;padding:16px}
    }
  </style>
</head>
<body class="web">
  <div class="toolbar" role="toolbar" aria-label="DOCX viewer toolbar">
    <div class="title">DOCX Viewer</div>
    <button id="btnWeb" class="btn primary" title="Web layout">Web layout</button>
    <button id="btnPrint" class="btn" title="Print layout">Print layout</button>
    <button id="btnPrintNow" class="btn" title="Print document">Print</button>
    <div class="spacer"></div>
    <div style="color:rgba(255,255,255,.8);font-size:13px">Source: <span style="font-weight:600">sample3.docx</span></div>
  </div>

  <main class="viewer-wrap">
    <div class="viewer" id="viewer">
      <div id="status" style="padding:32px;text-align:center">
        <div class="loading" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div style="margin-top:10px;color:#374151">Loading document...</div>
      </div>
      <div id="doc" class="doc-content" style="display:none"></div>
    </div>
  </main>

  <!-- Mammoth.js to convert docx to HTML in-browser -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script>
    (function(){
      // Fixed file URL (user cannot change it)
      const DOCX_URL = 'doc/sample3.docx';

      const viewerEl = document.getElementById('viewer');
      const docEl = document.getElementById('doc');
      const statusEl = document.getElementById('status');
      const rootBody = document.body;

      // Utility: create a page element
      function createPage(){
        const page = document.createElement('div');
        page.className = 'page';
        return page;
      }

      // Simple pagination: split top-level nodes into multiple .page containers
      function paginateHtml(html){
        // source container sized like a page so measurements match
        const source = document.createElement('div');
        source.style.width = '210mm';
        source.style.visibility = 'hidden';
        source.style.position = 'absolute';
        source.style.left = '-9999px';
        source.innerHTML = html;
        document.body.appendChild(source);

        // measure page height using a sample page
        const sample = createPage();
        sample.style.visibility = 'hidden';
        sample.style.position = 'absolute';
        sample.style.left = '-9999px';
        document.body.appendChild(sample);
        const pageHeight = sample.clientHeight;
        document.body.removeChild(sample);

        // create pages and fill them with top-level nodes
        docEl.innerHTML = '';
        let currentPage = createPage();
        docEl.appendChild(currentPage);

        const nodes = Array.from(source.childNodes);
        for(const node of nodes){
          // clone node so we don't disturb the original
          const clone = node.cloneNode(true);
          currentPage.appendChild(clone);

          // if current page overflowed, move the node to a new page
          if(currentPage.scrollHeight > pageHeight){
            currentPage.removeChild(clone);
            currentPage = createPage();
            docEl.appendChild(currentPage);
            currentPage.appendChild(clone);
          }
        }

        document.body.removeChild(source);
      }

      // Fetch and convert docx
      async function loadDoc(asPrintLayout = false){
        statusEl.style.display = '';
        docEl.style.display = 'none';
        statusEl.querySelector('div[style]').textContent = 'Loading document...';
        try{
          const resp = await fetch(DOCX_URL);
          if(!resp.ok) throw new Error('Failed to fetch docx: ' + resp.status);
          const arrayBuffer = await resp.arrayBuffer();
          const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer});
          const html = result.value;

          if(asPrintLayout){
            // paginate top-level elements into pages
            paginateHtml(html);
          } else {
            docEl.innerHTML = html;
          }

          // hide status, show doc
          statusEl.style.display = 'none';
          docEl.style.display = '';

        }catch(err){
          statusEl.querySelector('div[style]').textContent = 'Error loading document.';
          console.error(err);
        }
      }

      // Initial load: web layout
      loadDoc(false);

      // Toolbar buttons
      document.getElementById('btnWeb').addEventListener('click', ()=>{
        rootBody.classList.remove('print');
        rootBody.classList.add('web');
        document.getElementById('btnWeb').classList.add('primary');
        document.getElementById('btnPrint').classList.remove('primary');
        // re-render as web
        loadDoc(false);
      });

      document.getElementById('btnPrint').addEventListener('click', ()=>{
        rootBody.classList.remove('web');
        rootBody.classList.add('print');
        document.getElementById('btnPrint').classList.add('primary');
        document.getElementById('btnWeb').classList.remove('primary');
        // re-render as print
        loadDoc(true);
      });

      document.getElementById('btnPrintNow').addEventListener('click', ()=>{
        window.print();
      });

      // Accessibility: keyboard shortcuts
      window.addEventListener('keydown', (e)=>{
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='p'){
          e.preventDefault();
          window.print();
        }
      });

      // Ensure viewer area has white background
      document.querySelector('.viewer-wrap').style.background = '#ffffff';

      // Security: do not expose or allow changing the DOCX_URL
      Object.defineProperty(window, 'DOCX_URL', {value: DOCX_URL, writable:false, configurable:false});

    })();
  </script>
</body>
</html>
