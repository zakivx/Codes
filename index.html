<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Template Filler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 16px;
      resize: none;
      overflow-y: hidden;
    }
    #fieldsContainer {
      padding-top: 20px;
    }
    .field-label {
      margin-top: 10px;
      display: block;
      font-weight: bold;
    }
    .field-input {
      width: 100%;
      min-height: 30px;
      box-sizing: border-box;
      font-size: 14px;
      padding: 6px;
      margin-bottom: 10px;
      resize: none;
      overflow-y: hidden;
    }
    #result {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      background-color: #f9f9f9;
      white-space: pre-wrap;
    }
    #alert {
      color: green;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>üìù Template Editor</h2>

  <textarea id="templateInput" rows="1" placeholder="Enter your template here..." oninput="autoResize(this); generateFields()">
A {{Years | 50}}-year-old {{sex | male}} presents to the clinic with complaints of {{symptoms | persistent fatigue, central obesity, and decreased libido}}. He reports a history of {{duration | 12 years}} of progressive weight gain and mood disturbances. On examination, he exhibits signs of {{signs | gynecomastia, alopecia, and increased abdominal adiposity}}. Laboratory investigations reveal a {{lab_findings | low TSH with normal free T4, and elevated LDL cholesterol}}. 

What is the most appropriate initial management step?
  </textarea>

  <br><br>

  <button onclick="showAddFieldBox()">‚ûï Add Field</button>
  
  <button onclick="saveAsHtml()">üíæ Save as HTML</button>

  

  <div id="addFieldBox" style="display:none; margin-top: 10px;">
    <input id="newFieldName" placeholder="Field name">
    <input id="newDefaultValue" placeholder="Default value">
    <button onclick="insertFieldAtCursor()">Insert</button>
  </div>

  <div id="fieldsContainer"></div>

  <div id="result"></div>
<button onclick="copyResult()" style="margin-top:10px">üìã Copy Result</button>
  <div id="alert"></div>
  <script>
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    function getFieldsFromTemplate(template) {
      const regex = /\{\{\s*(\w+)\s*\|\s*([^}]+?)\s*\}\}/g;
      const fields = new Map();
      let match;
      while ((match = regex.exec(template)) !== null) {
        fields.set(match[1], match[2]);
      }
      return fields;
    }

    function generateFields() {
      const template = document.getElementById('templateInput').value;
      const fields = getFieldsFromTemplate(template);
      const container = document.getElementById('fieldsContainer');
      container.innerHTML = '';

      fields.forEach((defaultValue, fieldName) => {
        const label = document.createElement('label');
        label.textContent = fieldName;
        label.className = 'field-label';

        const input = document.createElement('textarea');
        input.className = 'field-input';
        input.value = defaultValue;
        input.rows = 1;
        input.oninput = function () {
          autoResize(this);
          updateResult();
        };

        input.setAttribute('data-field', fieldName);
        container.appendChild(label);
        container.appendChild(input);

        // Auto resize initially
        autoResize(input);
      });

      updateResult();
    }

    function updateResult() {
      let result = document.getElementById('templateInput').value;
      const inputs = document.querySelectorAll('.field-input');
      inputs.forEach(input => {
        const field = input.getAttribute('data-field');
        const value = input.value;
        const regex = new RegExp(`\\{\\{\\s*${field}\\s*\\|[^}]+\\s*\\}\\}`, 'g');
        result = result.replace(regex, value);
      });
      document.getElementById('result').textContent = result;
    }

    function copyResult() {
      const resultText = document.getElementById('result').textContent;
      navigator.clipboard.writeText(resultText).then(() => {
        document.getElementById('alert').textContent = '‚úÖ Copied!';
        setTimeout(() => {
          document.getElementById('alert').textContent = '';
        }, 2000);
      });
    }

    function showAddFieldBox() {
      document.getElementById('addFieldBox').style.display = 'block';
    }

    function insertFieldAtCursor() {
      const name = document.getElementById('newFieldName').value.trim();
      const value = document.getElementById('newDefaultValue').value.trim();
      if (!name || !value) return;

      const textarea = document.getElementById('templateInput');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const insertText = `{{${name} | ${value}}}`;

      textarea.value = text.slice(0, start) + insertText + text.slice(end);
      textarea.focus();
      textarea.selectionEnd = start + insertText.length;

      autoResize(textarea);
      generateFields();

      document.getElementById('addFieldBox').style.display = 'none';
      document.getElementById('newFieldName').value = '';
      document.getElementById('newDefaultValue').value = '';
    }

    function saveAsHtml() {
      let doc = document.documentElement.outerHTML;
      const templateText = document.getElementById('templateInput').value;
      doc = doc.replace(
        /<textarea id="templateInput"[\s\S]*?>[\s\S]*?<\/textarea>/,
        `<textarea id="templateInput" rows="1" placeholder="Enter your template here..." oninput="autoResize(this); generateFields()">${templateText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</textarea>`
      );
      const blob = new Blob([doc], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'file.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Initialize on load
    window.onload = function () {
      autoResize(document.getElementById('templateInput'));
      generateFields();
    };
  </script>
</body>
</html>
