<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Template Filler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #templateEditor {
      width: 100%;
      min-height: 120px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 16px;
      white-space: pre-wrap;
      outline: none;
    }

    #fieldsContainer {
      padding-top: 20px;
    }

    .inputField {
      display: block;
      width: 100%;
      max-width: 600px;
      margin-bottom: 10px;
      font-size: 16px;
      padding: 6px;
      box-sizing: border-box;
      resize: none;
      overflow: hidden;
    }

    #result {
      margin-top: 20px;
      white-space: pre-wrap;
      border: 1px solid #ddd;
      padding: 10px;
    }

    button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>Template Editor</h2>

  <div id="templateEditor" contenteditable="true" oninput="onEditorInput()"></div>
  <textarea id="templateInput" style="display:none;"></textarea>

  <button onclick="insertField()">Insert Field</button>
  <div id="fieldsContainer"></div>

  <h3>Result</h3>
  <div id="result"></div>
  <button onclick="copyResult()">Copy Result</button>
  <button onclick="saveAsHTML()">Save as file.html</button>

  <script>
    function onEditorInput() {
      const editor = document.getElementById('templateEditor');
      const text = editor.innerText;
      document.getElementById('templateInput').value = text;
      highlightTemplate();
      generateFields();
    }

    function highlightTemplate() {
      const editor = document.getElementById('templateEditor');

      // Save caret position
      const caretOffset = getCaretCharacterOffsetWithin(editor);

      const rawText = editor.innerText;

      const highlighted = rawText.replace(/\{\{\s*(\w+)\s*\|\s*([^}]+?)\s*\}\}/g, (_, field, value) => {
        return `{{<span style="color:red">${field}</span> | <span style="color:green">${value}</span>}}`;
      }).replace(/\n/g, "<br>").replace(/ {2}/g, " &nbsp;");

      editor.innerHTML = highlighted;

      // Restore caret
      restoreCaretToOffset(editor, caretOffset);
    }

    function getCaretCharacterOffsetWithin(element) {
      let caretOffset = 0;
      const sel = window.getSelection();
      if (sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(element);
        preCaretRange.setEnd(range.endContainer, range.endOffset);
        caretOffset = preCaretRange.toString().length;
      }
      return caretOffset;
    }

    function restoreCaretToOffset(container, offset) {
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
      let currentNode = null;
      let currentOffset = 0;

      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (currentOffset + node.length >= offset) {
          const range = document.createRange();
          range.setStart(node, offset - currentOffset);
          range.collapse(true);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          return;
        }
        currentOffset += node.length;
      }
    }

    function generateFields() {
      const text = document.getElementById('templateInput').value;
      const matches = [...text.matchAll(/\{\{\s*(\w+)\s*\|\s*([^}]+?)\s*\}\}/g)];

      const fieldsContainer = document.getElementById('fieldsContainer');
      fieldsContainer.innerHTML = '';

      matches.forEach(([_, field, defaultValue]) => {
        const label = document.createElement('label');
        label.textContent = field;

        const textarea = document.createElement('textarea');
        textarea.className = 'inputField';
        textarea.name = field;
        textarea.value = defaultValue;
        textarea.oninput = updateResult;

        textarea.addEventListener('input', () => autoResize(textarea));

        fieldsContainer.appendChild(label);
        fieldsContainer.appendChild(textarea);

        // Fix: defer resizing until layout is complete
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            autoResize(textarea);
          });
        });
      });

      updateResult();
    }

    function autoResize(el) {
      el.style.height = '40px';
      el.style.height = el.scrollHeight + 'px';
    }

    function updateResult() {
      let result = document.getElementById('templateInput').value;

      const inputs = document.querySelectorAll('.inputField');
      inputs.forEach(input => {
        const field = input.name;
        const value = input.value;
        const regex = new RegExp(`\\{\\{\\s*${field}\\s*\\|\\s*[^}]+?\\s*\\}\\}`, 'g');
        result = result.replace(regex, value);
      });

      document.getElementById('result').textContent = result;
    }

    function copyResult() {
      const result = document.getElementById('result').innerText;
      navigator.clipboard.writeText(result).then(() => {
        alert("Result copied to clipboard.");
      });
    }

    function insertField() {
      const fieldName = prompt("Field name:");
      if (!fieldName) return;
      const defaultValue = prompt("Default value:");
      const insertText = `{{${fieldName} | ${defaultValue}}}`;

      const editor = document.getElementById('templateEditor');
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(insertText));

      onEditorInput();
    }

    function saveAsHTML() {
      const content = document.getElementById('templateInput').value;
      const blob = new Blob(
        [`<html><body><pre>${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre></body></html>`],
        { type: "text/html" }
      );
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "file.html";
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = () => {
      const defaultTemplate = `A {{Years | 50}}-year-old {{sex | male}} presents to the clinic with complaints of {{symptoms | persistent fatigue, central obesity, and decreased libido}}.\nOn examination, he exhibits signs of {{signs | gynecomastia, alopecia, and increased abdominal adiposity}}.\nLaboratory investigations reveal a {{lab_findings | low TSH with normal free T4, and elevated LDL cholesterol}}.\n\nWhat is the most appropriate initial management step?`;
      document.getElementById('templateInput').value = defaultTemplate;
      document.getElementById('templateEditor').innerText = defaultTemplate;
      highlightTemplate();
      generateFields();
    };
  </script>
</body>
</html>
