<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CPR Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; text-align: center; margin: 10px; padding:0; }

.box {
    width: 80%; 
    max-width: 300px;
    height: 40px;  
    margin: 15px auto;
    font-size: 16px;  
    font-weight: bold; 
    display: flex;
    justify-content: center; 
    align-items: center;
    border-radius: 10px; 
    border: 4px solid gray;
    background: transparent; 
    color: gray;
    transition: background 0.1s ease, color 0.1s ease;
}
.breath-on { background: #1e90ff; color: white; }
.compress-on { background: #ff3333; color: white; }

input { padding: 8px; font-size: 16px; width: 70px; margin: 3px; text-align: center; }
button { font-size: 16px; padding: 8px 12px; margin: 3px; border-radius: 5px; }

#timer, #rhythmTimer { font-size: 18px; font-weight: bold; margin: 3px; }

.section { margin-top: 15px; padding: 10px; border: 2px solid #ddd; border-radius: 10px; width: 95%; max-width: 600px; margin-left: auto; margin-right: auto; }

.title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
.event-log { max-height: 200px; overflow-y: auto; text-align: left; word-wrap: break-word; margin-top:10px; }

/* Rhythm check button colors */
#rhythmButton { border: none; border-radius: 5px; color: white; cursor: pointer; }
#rhythmButton.stopped { background-color: green; }
#rhythmButton.running { background-color: red; }

/* Flex rows */
.row { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 5px; }
.row > * { margin: 3px; }

/* Input column layout */
.input-group { display: flex; flex-direction: column; align-items: center; margin: 3px; }
.input-group label { font-size: 14px; margin-bottom: 2px; }

/* Shine animation */
@keyframes shine {
    0%,100% { background-color: transparent; color: gray; }
    50% { background-color: yellow; color: black; }
}
.shine {
    animation: shine 1s infinite;
}
</style>
</head>
<body>

<h2>CPR Simulator</h2>

<!-- Inputs row -->
<div class="row">
    <div class="input-group"><label>Breaths/min</label><input id="breathRate" type="number" value="10"></div>
    <div class="input-group"><label>Compressions/min</label><input id="compressRate" type="number" value="120"></div>
    <div class="input-group"><label>Joules</label><input id="joulesInput" type="number" value="200"></div>
</div>

<!-- CPR Controls -->
<div class="row">
    <button onclick="startCPR()">Start CPR</button>
    <button onclick="stopCPR()">Stop CPR</button>
    <button onclick="resetAll()">Reset</button>
</div>

<!-- Timers row -->
<div class="row">
    <div id="timer">CPR: 00:00</div>
    <div id="rhythmTimer">Rhy: 00:00</div>
    <div id="epiTimer">Epi: 00:00</div>
    <div id="amioTimer">Amio: 00:00</div>
    <div id="lidoTimer">Lido: 00:00</div>
</div>

<!-- Counts row -->
<div class="row">
    <div id="epiCount">Epi: 0</div>
    <div id="amioCount">Amio: 0</div>
    <div id="lidoCount">Lido: 0</div>
    <div id="shockCount">Shock: 0</div>
</div>

<!-- Flash boxes -->
<div id="breathBox" class="box">BREATH</div>
<div id="compressBox" class="box">COMPRESS</div>
<div id="lastEventTimer" class="box">Last Event: 00:00</div>

<!-- Action buttons row -->
<div class="row">
    <button onclick="adminDrug('epi')">Epi</button>
    <button onclick="adminDrug('amio')">Amio</button>
    <button onclick="adminDrug('lido')">Lido</button>
    <button id="rhythmButton" onclick="toggleRhythmCheck()">Rhy</button>
    <button onclick="defibrillate()">Def</button>
</div>

<!-- Event log -->
<div class="section">
    <div class="title">Event History</div>
    <div id="eventLog" class="event-log"></div>
</div>

<script>
let breathInterval, compressInterval, cprTimerInterval;
let cprRunning = false;
let secondsPassed = 0;

let rhythmRunning = false;
let rhythmTimerInterval;
let rhythmSeconds = 0;
let rhythmStartTime = 0;

let shockCount = 0;

let drugData = {
    epi: {seconds:0, count:0, timerId:null},
    amio: {seconds:0, count:0, timerId:null},
    lido: {seconds:0, count:0, timerId:null}
};

// Last event timer
let lastEventSeconds = 0;
let lastEventInterval = null;

// Wake Lock
let wakeLock = null;

async function requestWakeLock(){
    try{
        if('wakeLock' in navigator){
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', ()=> console.log('Wake Lock released'));
        }
    } catch(err){ console.log(err.name, err.message); }
}

// Keep wake lock if page visibility changes
document.addEventListener('visibilitychange', () => {
    if(wakeLock !== null && document.visibilityState === 'visible'){
        requestWakeLock();
    }
});

function flashBox(box, className, duration){
    box.classList.add(className);
    setTimeout(()=> box.classList.remove(className), duration);
}

function formatMMSS(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
}

// Event log
function logEvent(message){
    const log = document.getElementById("eventLog");
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    log.innerHTML += `[${time}] ${message}<br>`;
    log.scrollTop = log.scrollHeight;
    saveState();
}

// CPR
function startCPR(){
    if(cprRunning) stopCPR();
    cprRunning = true;

    requestWakeLock();

    const breathBox = document.getElementById("breathBox");
    const compressBox = document.getElementById("compressBox");

    const breathsPerMin = Number(document.getElementById("breathRate").value);
    const compressPerMin = Number(document.getElementById("compressRate").value);

    const breathIntervalMs = 60000/breathsPerMin;
    const compressIntervalMs = 60000/compressPerMin;

    cprTimerInterval = setInterval(()=>{
        secondsPassed++;
        document.getElementById("timer").textContent = "CPR: "+formatMMSS(secondsPassed);
        saveState();
    },1000);

    breathInterval = setInterval(()=> flashBox(breathBox,"breath-on",700), breathIntervalMs);
    compressInterval = setInterval(()=> flashBox(compressBox,"compress-on",200), compressIntervalMs);

    flashBox(breathBox,"breath-on",700);
    flashBox(compressBox,"compress-on",200);

    logEvent("CPR Started");
}

function stopCPR(){
    if(!cprRunning) return;
    clearInterval(breathInterval);
    clearInterval(compressInterval);
    clearInterval(cprTimerInterval);
    cprRunning = false;
    logEvent("CPR Stopped");
}

// Drugs
function adminDrug(drug){
    const data = drugData[drug];
    data.count++;
    data.seconds=0;
    document.getElementById(drug+"Count").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+data.count;
    document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": 00:00";
    clearInterval(data.timerId);
    data.timerId = setInterval(()=>{
        data.seconds++;
        document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+formatMMSS(data.seconds);
        saveState();
    },1000);
    logEvent(`Drug given: ${drug.toUpperCase()}`);
    updateLastEvent();
}

// Rhythm Check
function toggleRhythmCheck() {
    const btn = document.getElementById("rhythmButton");
    if (!rhythmRunning) {
        rhythmRunning = true;
        rhythmSeconds = 0;
        rhythmStartTime = secondsPassed;
        document.getElementById("rhythmTimer").textContent = "Rhy: 00:00";

        rhythmTimerInterval = setInterval(() => {
            rhythmSeconds++;
            document.getElementById("rhythmTimer").textContent = "Rhy: " + formatMMSS(rhythmSeconds);
            saveState();
        }, 1000);

        btn.classList.remove("stopped");
        btn.classList.add("running");
        logEvent("Rhythm Check Started");
    } else {
        clearInterval(rhythmTimerInterval);
        rhythmRunning = false;
        btn.classList.remove("running");
        btn.classList.add("stopped");

        const duration = rhythmSeconds;
        logEvent(`Rhythm Check Stopped (Duration: ${formatMMSS(duration)})`);
    }
}

// Defibrillate
function defibrillate(){
    let joulesField = document.getElementById("joulesInput");
    let joules = Number(joulesField.value);
    if(joules && joules > 0){
        shockCount++;
        document.getElementById("shockCount").textContent = "Shock: "+shockCount;
        logEvent(`Defibrillated: ${joules} J (Shock #${shockCount})`);
        updateLastEvent();
        saveState();
    } else {
        alert("Please enter a valid number of joules.");
    }
}

// Last event timer
function resetLastEventTimer(){
    lastEventSeconds = 0;
    const box = document.getElementById("lastEventTimer");
    box.textContent = "Last Event: 00:00";
    box.classList.remove("shine");
}

function startLastEventTimer(){
    if(lastEventInterval) return; // already running
    lastEventInterval = setInterval(()=>{
        lastEventSeconds++;
        const box = document.getElementById("lastEventTimer");
        box.textContent = "Last Event: "+formatMMSS(lastEventSeconds);

        if(lastEventSeconds >= 120){
            box.classList.add("shine");
        } else {
            box.classList.remove("shine");
        }
    },1000);
}

function updateLastEvent(){
    resetLastEventTimer();
    startLastEventTimer();
}

// Reset
function resetAll(){
    stopCPR();

    if(rhythmRunning){
        clearInterval(rhythmTimerInterval);
        rhythmRunning = false;
    }

    rhythmSeconds = 0;
    rhythmStartTime = 0;
    document.getElementById("rhythmTimer").textContent = "Rhy: 00:00";
    document.getElementById("rhythmButton").classList.remove("running");
    document.getElementById("rhythmButton").classList.add("stopped");

    document.getElementById("eventLog").innerHTML = "";
    secondsPassed = 0;
    document.getElementById("timer").textContent = "CPR: 00:00";

    shockCount = 0;
    document.getElementById("shockCount").textContent = "Shock: 0";

    if(lastEventInterval){
        clearInterval(lastEventInterval);
        lastEventInterval = null;
    }
    resetLastEventTimer();

    for(let drug in drugData){
        clearInterval(drugData[drug].timerId);
        drugData[drug].count = 0;
        drugData[drug].seconds = 0;
        document.getElementById(drug+"Count").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": 0";
        document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": 00:00";
    }

    saveState();
}

// LocalStorage
function saveState(){
    const state = {
        secondsPassed,
        eventLog: document.getElementById("eventLog").innerHTML,
        drugData: {
            epi: {seconds: drugData.epi.seconds, count: drugData.epi.count},
            amio: {seconds: drugData.amio.seconds, count: drugData.amio.count},
            lido: {seconds: drugData.lido.seconds, count: drugData.lido.count}
        },
        rhythmRunning,
        rhythmSeconds,
        rhythmStartTime,
        shockCount,
        lastEventSeconds,
        joules: document.getElementById("joulesInput").value,
        breathRate: document.getElementById("breathRate").value,
        compressRate: document.getElementById("compressRate").value
    };
    localStorage.setItem("cprState", JSON.stringify(state));
}

function loadState(){
    const saved = localStorage.getItem("cprState");
    if(!saved) return;
    const state = JSON.parse(saved);
    secondsPassed = state.secondsPassed || 0;
    document.getElementById("timer").textContent = "CPR: "+formatMMSS(secondsPassed);
    document.getElementById("eventLog").innerHTML = state.eventLog || "";
    document.getElementById("joulesInput").value = state.joules || 200;
    document.getElementById("breathRate").value = state.breathRate || 10;
    document.getElementById("compressRate").value = state.compressRate || 120;

    shockCount = state.shockCount || 0;
    document.getElementById("shockCount").textContent = "Shock: "+shockCount;

    lastEventSeconds = state.lastEventSeconds || 0;

    for(let drug in state.drugData){
        drugData[drug].count = state.drugData[drug].count || 0;
        drugData[drug].seconds = state.drugData[drug].seconds || 0;
        document.getElementById(drug+"Count").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+drugData[drug].count;
        document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+formatMMSS(drugData[drug].seconds);

        if(drugData[drug].seconds > 0){
            clearInterval(drugData[drug].timerId);
            drugData[drug].timerId = setInterval(()=>{
                drugData[drug].seconds++;
                document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+formatMMSS(drugData[drug].seconds);
                saveState();
            },1000);
        }
    }

    rhythmRunning = state.rhythmRunning || false;
    rhythmSeconds = state.rhythmSeconds || 0;
    rhythmStartTime = state.rhythmStartTime || 0;
    const btn = document.getElementById("rhythmButton");
    if(rhythmRunning){
        btn.classList.add("running");
        rhythmTimerInterval = setInterval(()=>{
            rhythmSeconds++;
            document.getElementById("rhythmTimer").textContent = "Rhy: " + formatMMSS(rhythmSeconds);
            saveState();
        },1000);
    } else {
        btn.classList.add("stopped");
        document.getElementById("rhythmTimer").textContent = "Rhy: "+formatMMSS(rhythmSeconds);
    }

    document.getElementById("lastEventTimer").textContent = "Last Event: "+formatMMSS(lastEventSeconds);
}

window.onload = () => loadState();
</script>

</body>
</html>
