<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CPR Simulator2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; text-align: center; margin: 10px; padding:0; }

.box {
    width: 80%; 
    max-width: 300px;
    height: 40px;  
    margin: 15px auto;
    font-size: 16px;  
    font-weight: bold; 
    display: flex;
    justify-content: center; 
    align-items: center;
    border-radius: 10px; 
    border: 4px solid gray;
    background: transparent; 
    color: gray;
    transition: background 0.1s ease, color 0.1s ease;
}
.breath-on { background: #1e90ff; color: white; }
.compress-on { background: #ff3333; color: white; }

input { padding: 8px; font-size: 16px; width: 70px; margin: 3px; text-align: center; }
button { font-size: 16px; padding: 8px 12px; margin: 3px; border-radius: 5px; }

#timer, #rhythmTimer { font-size: 18px; font-weight: bold; margin: 3px; }

.section { margin-top: 15px; padding: 10px; border: 2px solid #ddd; border-radius: 10px; width: 95%; max-width: 600px; margin-left: auto; margin-right: auto; }

.title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
.event-log { max-height: 200px; overflow-y: auto; text-align: left; word-wrap: break-word; margin-top:10px; }

/* Rhythm check button colors */
#rhythmButton { border: none; border-radius: 5px; color: white; cursor: pointer; }
#rhythmButton.stopped { background-color: green; }
#rhythmButton.running { background-color: red; }

/* Flex rows */
.row { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 5px; }
.row > * { margin: 3px; }

/* Input column layout */
.input-group { display: flex; flex-direction: column; align-items: center; margin: 3px; }
.input-group label { font-size: 14px; margin-bottom: 2px; }

/* Shine animation */
@keyframes shine {
    0%,100% { background-color: transparent; color: gray; }
    50% { background-color: yellow; color: black; }
}
.shine {
    animation: shine 1s infinite;
}

/* Keep alive animation */
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.5; }
}
#keepAlive {
    width: 10px;
    height: 10px;
    background-color: green;
    position: fixed;
    bottom: 5px;
    right: 5px;
    animation: pulse 1s infinite;
}
</style>
</head>
<body>

<h2>CPR Simulator</h2>

<!-- Keep alive tiny animation -->
<div id="keepAlive"></div>

<!-- Inputs row -->
<div class="row">
    <div class="input-group"><label>Breaths/min</label><input id="breathRate" type="number" value="10"></div>
    <div class="input-group"><label>Compressions/min</label><input id="compressRate" type="number" value="120"></div>
    <div class="input-group"><label>Joules</label><input id="joulesInput" type="number" value="200"></div>
</div>

<!-- CPR Controls -->
<div class="row">
    <button onclick="startCPR()">Start CPR</button>
    <button onclick="stopCPR()">Stop CPR</button>
    <button onclick="resetAll()">Reset</button>
</div>

<!-- Timers row -->
<div class="row">
    <div id="timer">CPR: 00:00</div>
    <div id="rhythmTimer">Rhy: 00:00</div>
    <div id="epiTimer">Epi: 00:00</div>
    <div id="amioTimer">Amio: 00:00</div>
    <div id="lidoTimer">Lido: 00:00</div>
</div>

<!-- Counts row -->
<div class="row">
    <div id="epiCount">Epi: 0</div>
    <div id="amioCount">Amio: 0</div>
    <div id="lidoCount">Lido: 0</div>
    <div id="shockCount">Shock: 0</div>
</div>

<!-- Flash boxes -->
<div id="breathBox" class="box">BREATH</div>
<div id="compressBox" class="box">COMPRESS</div>
<div id="lastEventTimer" class="box">Last Event: 00:00</div>

<!-- Action buttons row -->
<div class="row">
    <button onclick="adminDrug('epi')">Epi</button>
    <button onclick="adminDrug('amio')">Amio</button>
    <button onclick="adminDrug('lido')">Lido</button>
    <button id="rhythmButton" onclick="toggleRhythmCheck()">Rhy</button>
    <button onclick="defibrillate()">Def</button>
</div>

<!-- Event log -->
<div class="section">
    <div class="title">Event History</div>
    <div id="eventLog" class="event-log"></div>
</div>

<script>
// ----- Core variables -----
let breathInterval, compressInterval, cprTimerInterval;
let cprRunning = false;
let cprStartTime = null;

let rhythmRunning = false;
let rhythmStartTime = null;

let shockCount = 0;

let drugData = {
    epi: {startTime:null, count:0, intervalId:null},
    amio: {startTime:null, count:0, intervalId:null},
    lido: {startTime:null, count:0, intervalId:null}
};

let lastEventStartTime = null;
let lastEventInterval = null;

// ----- Utils -----
function formatMMSS(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
}
function formatTime(hSec){ 
    const h = String(Math.floor(hSec/3600)).padStart(2,"0");
    const m = String(Math.floor((hSec%3600)/60)).padStart(2,"0");
    const s = String(hSec%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
}
function flashBox(box, className, duration){
    box.classList.add(className);
    setTimeout(()=> box.classList.remove(className), duration);
}
function logEvent(message){
    const log = document.getElementById("eventLog");
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    log.innerHTML += `[${time}] ${message}<br>`;
    log.scrollTop = log.scrollHeight;
    saveState();
}

// ----- Timer Updaters -----
function updateCPRTimer(){
    if(!cprStartTime) return;
    const elapsedSec = Math.floor((Date.now() - cprStartTime)/1000);
    document.getElementById("timer").textContent = "CPR: "+formatMMSS(elapsedSec);
}
function updateRhythmTimer(){
    if(!rhythmStartTime) return;
    const elapsedSec = Math.floor((Date.now() - rhythmStartTime)/1000);
    document.getElementById("rhythmTimer").textContent = "Rhy: "+formatMMSS(elapsedSec);
}
function updateDrugTimer(drug){
    if(!drugData[drug].startTime) return;
    const elapsedSec = Math.floor((Date.now() - drugData[drug].startTime)/1000);
    document.getElementById(drug+"Timer").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+formatMMSS(elapsedSec);
}
function updateLastEventTimer(){
    if(!lastEventStartTime) return;
    const elapsedSec = Math.floor((Date.now() - lastEventStartTime)/1000);
    const box = document.getElementById("lastEventTimer");
    box.textContent = "Last Event: "+formatMMSS(elapsedSec);
    if(elapsedSec >= 120){
        box.classList.add("shine");
    } else { box.classList.remove("shine"); }
}

// ----- CPR -----
function startCPR(){
    if(cprRunning) stopCPR();
    cprRunning = true;
    cprStartTime = Date.now();

    const breathBox = document.getElementById("breathBox");
    const compressBox = document.getElementById("compressBox");

    const breathsPerMin = Number(document.getElementById("breathRate").value);
    const compressPerMin = Number(document.getElementById("compressRate").value);
    const breathMs = 60000/breathsPerMin;
    const compressMs = 60000/compressPerMin;

    cprTimerInterval = setInterval(updateCPRTimer,1000);
    breathInterval = setInterval(()=> flashBox(breathBox,"breath-on",700), breathMs);
    compressInterval = setInterval(()=> flashBox(compressBox,"compress-on",200), compressMs);

    flashBox(breathBox,"breath-on",700);
    flashBox(compressBox,"compress-on",200);
    logEvent("CPR Started");
}
function stopCPR(){
    if(!cprRunning) return;
    clearInterval(cprTimerInterval);
    clearInterval(breathInterval);
    clearInterval(compressInterval);
    cprRunning = false;
    logEvent("CPR Stopped");
}

// ----- Drugs -----
function adminDrug(drug){
    drugData[drug].count++;
    drugData[drug].startTime = Date.now();
    clearInterval(drugData[drug].intervalId);
    updateDrugTimer(drug);
    drugData[drug].intervalId = setInterval(()=>updateDrugTimer(drug),1000);
    document.getElementById(drug+"Count").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+drugData[drug].count;
    logEvent(`Drug given: ${drug.toUpperCase()}`);
    updateLastEvent();
}

// ----- Rhythm -----
function toggleRhythmCheck(){
    const btn = document.getElementById("rhythmButton");
    if(!rhythmRunning){
        rhythmRunning = true;
        rhythmStartTime = Date.now();
        btn.classList.remove("stopped");
        btn.classList.add("running");
        setInterval(updateRhythmTimer,1000);
        logEvent("Rhythm Check Started");
    } else {
        rhythmRunning = false;
        btn.classList.remove("running");
        btn.classList.add("stopped");
        const elapsedSec = Math.floor((Date.now() - rhythmStartTime)/1000);
        logEvent(`Rhythm Check Stopped (Duration: ${formatMMSS(elapsedSec)})`);
    }
}

// ----- Defibrillation -----
function defibrillate(){
    const joules = Number(document.getElementById("joulesInput").value);
    if(joules>0){
        shockCount++;
        document.getElementById("shockCount").textContent = "Shock: "+shockCount;
        logEvent(`Defibrillated: ${joules} J (Shock #${shockCount})`);
        updateLastEvent();
    }
}

// ----- Last Event -----
function updateLastEvent(){
    lastEventStartTime = Date.now();
    if(!lastEventInterval) lastEventInterval = setInterval(updateLastEventTimer,1000);
}

// ----- Reset -----
function resetAll(){
    stopCPR();
    rhythmRunning = false;
    rhythmStartTime = null;
    document.getElementById("rhythmTimer").textContent="Rhy: 00:00";
    document.getElementById("rhythmButton").classList.remove("running");
    document.getElementById("rhythmButton").classList.add("stopped");
    
    cprStartTime = null;
    document.getElementById("timer").textContent="CPR: 00:00";

    shockCount=0;
    document.getElementById("shockCount").textContent="Shock: 0";

    lastEventStartTime=null;
    const box=document.getElementById("lastEventTimer");
    box.textContent="Last Event: 00:00";
    box.classList.remove("shine");

    for(let drug in drugData){
        clearInterval(drugData[drug].intervalId);
        drugData[drug].count=0;
        drugData[drug].startTime=null;
        document.getElementById(drug+"Count").textContent=drug.charAt(0).toUpperCase()+drug.slice(1)+": 0";
        document.getElementById(drug+"Timer").textContent=drug.charAt(0).toUpperCase()+drug.slice(1)+": 00:00";
    }
    document.getElementById("eventLog").innerHTML="";
    saveState();
}

// ----- LocalStorage -----
function saveState(){
    const state = {
        cprStartTime, rhythmStartTime, shockCount, lastEventStartTime,
        drugData: {
            epi:{startTime: drugData.epi.startTime, count: drugData.epi.count},
            amio:{startTime: drugData.amio.startTime, count: drugData.amio.count},
            lido:{startTime: drugData.lido.startTime, count: drugData.lido.count}
        },
        joules: document.getElementById("joulesInput").value,
        breathRate: document.getElementById("breathRate").value,
        compressRate: document.getElementById("compressRate").value,
        eventLog: document.getElementById("eventLog").innerHTML
    };
    localStorage.setItem("cprState", JSON.stringify(state));
}

function loadState(){
    const saved = JSON.parse(localStorage.getItem("cprState")||"{}");
    if(!saved) return;
    cprStartTime = saved.cprStartTime;
    if(cprStartTime) cprTimerInterval=setInterval(updateCPRTimer,1000);
    document.getElementById("timer").textContent = cprStartTime ? "CPR: "+formatMMSS(Math.floor((Date.now()-cprStartTime)/1000)):"CPR: 00:00";

    rhythmStartTime = saved.rhythmStartTime;
    const btn = document.getElementById("rhythmButton");
    if(rhythmStartTime){
        rhythmRunning=true;
        btn.classList.add("running");
        setInterval(updateRhythmTimer,1000);
    } else btn.classList.add("stopped");

    shockCount=saved.shockCount||0;
    document.getElementById("shockCount").textContent="Shock: "+shockCount;

    lastEventStartTime=saved.lastEventStartTime;
    if(lastEventStartTime) lastEventInterval=setInterval(updateLastEventTimer,1000);
    document.getElementById("lastEventTimer").textContent = lastEventStartTime ? "Last Event: "+formatMMSS(Math.floor((Date.now()-lastEventStartTime)/1000)):"Last Event: 00:00";

    for(let drug in saved.drugData||{}){
        drugData[drug].count=saved.drugData[drug].count||0;
        drugData[drug].startTime=saved.drugData[drug].startTime||null;
        document.getElementById(drug+"Count").textContent = drug.charAt(0).toUpperCase()+drug.slice(1)+": "+drugData[drug].count;
        if(drugData[drug].startTime){
            updateDrugTimer(drug);
            drugData[drug].intervalId=setInterval(()=>updateDrugTimer(drug),1000);
        } else document.getElementById(drug+"Timer").textContent=drug.charAt(0).toUpperCase()+drug.slice(1)+": 00:00";
    }

    document.getElementById("joulesInput").value = saved.joules||200;
    document.getElementById("breathRate").value = saved.breathRate||10;
    document.getElementById("compressRate").value = saved.compressRate||120;
    document.getElementById("eventLog").innerHTML = saved.eventLog||"";
}

window.onload = loadState;
</script>

</body>
</html>
