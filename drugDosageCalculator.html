<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Dosage Calculator</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  input, select { padding: 5px; margin-top: 5px; width: 300px; }
  .result { margin-top: 20px; font-weight: bold; }
  /* Searchable dropdown styling */
  .dropdown { position: relative; display: inline-block; width: 320px; }
  .dropdown input { width: 100%; box-sizing: border-box; }
  .dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ccc;
    z-index: 1000;
    width: 100%;
  }
  .dropdown-content div {
    padding: 5px;
    cursor: pointer;
  }
  .dropdown-content div:hover { background-color: #ddd; }
</style>
</head>
<body>

<h2>Drug Dosage Calculator</h2>

<label>
  Is the dosage weight-dependent?
  <select id="weightDep">
    <option value="no">No</option>
    <option value="yes">Yes</option>
  </select>
</label>

<div id="weightDiv" style="display:none;">
  <label>
    Patient weight (kg):
    <input type="number" id="weight" min="0" step="0.1">
  </label>
</div>

<label>Select predefined dilution or custom:</label>
<div class="dropdown">
  <input type="text" id="searchDropdown" placeholder="Search drug/dilution...">
  <div class="dropdown-content" id="dropdownContent"></div>
</div>

<div id="customDilution" style="display:none; margin-top:10px;">
  <label>
    Custom dilution:
    <input type="number" id="customNumber" min="0" step="0.01">
    <select id="customUnit">
      <option value="ug/ml">μg/ml</option>
      <option value="mg/ml">mg/ml</option>
    </select>
  </label>
</div>

<label>
  Enter dosage (single value or range, e.g., 8 or 8-12):
  <input type="text" id="dosageInput" placeholder="e.g., 8 or 0.01-3.3">
</label>

<label>
  Select dosage unit:
  <select id="dosageUnit">
    <option value="ug/min">μg/min</option>
    <option value="mcg/kg/min">μg/kg/min</option>
  </select>
</label>

<div class="result" id="result"></div>

<script>
const weightDep = document.getElementById('weightDep');
const weightDiv = document.getElementById('weightDiv');
const searchDropdown = document.getElementById('searchDropdown');
const dropdownContent = document.getElementById('dropdownContent');
const customDilution = document.getElementById('customDilution');
const dosageInput = document.getElementById('dosageInput');
const dosageUnit = document.getElementById('dosageUnit');
const weightInput = document.getElementById('weight');
const customNumberInput = document.getElementById('customNumber');
const customUnitInput = document.getElementById('customUnit');

// Dropdown options
const options = [
  "noradrenaline <10kg (50ug/ml)",
  "noradrenaline 10-25kg (100ug/ml)",
  "noradrenaline 25-50kg (200ug/ml)",
  "noradrenaline >50kg (250ug/ml)",
  "sufentanil <5kg (1ug/ml)",
  "sufentanil 5-10kg (2ug/ml)",
  "sufentanil 10-25kg (2ug/ml)",
  "sufentanil 25-50kg (5ug/ml)",
  "custom"
];

// Populate dropdown
function filterDropdown() {
  const val = searchDropdown.value.toLowerCase();
  dropdownContent.innerHTML = '';
  const filtered = options.filter(opt => opt.toLowerCase().includes(val));
  filtered.forEach(opt => {
    const div = document.createElement('div');
    div.textContent = opt;
    div.addEventListener('click', () => {
      searchDropdown.value = opt;
      dropdownContent.style.display = 'none';
      customDilution.style.display = opt.toLowerCase() === 'custom' ? 'block' : 'none';
      calculate();
    });
    dropdownContent.appendChild(div);
  });
  dropdownContent.style.display = filtered.length ? 'block' : 'none';
}

searchDropdown.addEventListener('input', filterDropdown);
searchDropdown.addEventListener('focus', filterDropdown);
document.addEventListener('click', e => {
  if(!e.target.closest('.dropdown')) {
    dropdownContent.style.display = 'none';
  }
});

// Unit filtering based on weight-dependent
const allUnits = Array.from(dosageUnit.options);
weightDep.addEventListener('change', () => {
  weightDiv.style.display = weightDep.value === 'yes' ? 'block' : 'none';
  updateDosageUnitOptions();
  calculate();
});

function updateDosageUnitOptions() {
  const weightDepended = weightDep.value === 'yes';
  dosageUnit.innerHTML = '';
  allUnits.forEach(opt => {
    const isWeightUnit = opt.value.includes('kg');
    if ((weightDepended && isWeightUnit) || (!weightDepended && !isWeightUnit)) {
      dosageUnit.appendChild(opt);
    }
  });
}

// Parse dilution from selected option
function parseDilution(input) {
  const match = input.match(/\(([\d.]+)\s*ug\/ml\)/i);
  if(match) return parseFloat(match[1]);
  if(input.toLowerCase() === 'custom') return null;
  return null;
}

// Calculation
[dosageInput, dosageUnit, weightInput, customNumberInput, customUnitInput, searchDropdown].forEach(el => {
  el.addEventListener('input', calculate);
});

function calculate() {
  let dilution = parseDilution(searchDropdown.value);
  const customNum = parseFloat(customNumberInput.value);
  const customUnit = customUnitInput.value;
  const weight = parseFloat(weightInput.value);

  if(searchDropdown.value.toLowerCase() === 'custom') {
    if(isNaN(customNum) || customNum <= 0) {
      document.getElementById('result').innerText = "";
      return;
    }
    dilution = customUnit === 'mg/ml' ? customNum * 1000 : customNum;
  }

  if(!dilution) return;

  const dosageStr = dosageInput.value.trim();
  if(!dosageStr) {
    document.getElementById('result').innerText = "";
    return;
  }

  const match = dosageStr.match(/^([\d.]+)(?:-([\d.]+))?$/);
  if(!match) {
    document.getElementById('result').innerText = "Invalid dosage format";
    return;
  }

  const lowValue = parseFloat(match[1]);
  const highValue = match[2] ? parseFloat(match[2]) : lowValue;

  let dosageUgPerMin;
  if(dosageUnit.value === 'mcg/kg/min') {
    if(isNaN(weight) || weight <= 0) {
      document.getElementById('result').innerText = "";
      return;
    }
    dosageUgPerMin = [lowValue * weight, highValue * weight];
  } else {
    dosageUgPerMin = [lowValue, highValue];
  }

  const mlLow = (dosageUgPerMin[0] / dilution).toFixed(2);
  const mlHigh = (dosageUgPerMin[1] / dilution).toFixed(2);

  const resultText = mlLow === mlHigh ? `${mlLow} mL/min` : `${mlLow} - ${mlHigh} mL/min`;
  document.getElementById('result').innerText = `Infusion rate: ${resultText}`;
}

// Initial setup
updateDosageUnitOptions();
calculate();
</script>

</body>
</html>
